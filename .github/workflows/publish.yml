# Automated Multi-Registry Publishing
# 
# This workflow publishes to npm, PyPI, Maven, and GitHub Packages
# Triggered by:
#   - Manual dispatch with version selection
#   - Push to tags matching v*
#   - Release creation

name: Publish to All Registries

on:
  # Manual trigger with version input
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 1.2.3)'
        required: false
        type: string
      prerelease:
        description: 'Is this a pre-release?'
        required: false
        type: boolean
        default: false
      registries:
        description: 'Registries to publish to'
        required: false
        type: choice
        options:
          - all
          - npm-only
          - pypi-only
          - maven-only
        default: all

  # Automatic trigger on version tags
  push:
    tags:
      - 'v*.*.*'
      - 'v*.*.*-*'  # Pre-release tags

  # Trigger on GitHub release
  release:
    types: [published]

jobs:
  # ==========================================
  # npm Publishing (JavaScript packages)
  # ==========================================
  publish-npm:
    name: Publish to npm
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'release' ||
      github.event_name == 'push' ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.registries == 'all' || github.event.inputs.registries == 'npm-only'))

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          always-auth: true

      - name: Determine Version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi

          if [ -z "$VERSION" ]; then
            echo "No release version detected."
          fi

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Detect Publishable Packages
        id: detect
        run: |
          node <<'NODE'
          const fs = require('fs');
          const path = require('path');

          const root = process.cwd();
          const candidateRoots = [
            path.join(root, 'packages'),
            path.join(root, 'languages', 'javascript', 'plugins')
          ];

          const publishDirs = [];

          for (const base of candidateRoots) {
            if (!fs.existsSync(base)) {
              continue;
            }

            const entries = fs.readdirSync(base, { withFileTypes: true });
            for (const entry of entries) {
              if (!entry.isDirectory()) continue;
              if (entry.name.startsWith('.')) continue;

              const dir = path.join(base, entry.name);
              const pkgPath = path.join(dir, 'package.json');
              if (!fs.existsSync(pkgPath)) continue;

              try {
                const pkg = JSON.parse(fs.readFileSync(pkgPath, 'utf8'));
                if (pkg.private) {
                  continue;
                }
                publishDirs.push(dir);
              } catch (error) {
                console.error(`Failed to parse ${pkgPath}: ${error.message}`);
                process.exit(1);
              }
            }
          }

          const outputFile = process.env.GITHUB_OUTPUT;
          if (!outputFile) {
            console.error('GITHUB_OUTPUT environment variable not set.');
            process.exit(1);
          }

          fs.appendFileSync(outputFile, `paths<<EOF\n${publishDirs.join('\n')}\nEOF\n`);
          fs.appendFileSync(outputFile, `has_packages=${publishDirs.length > 0 ? 'true' : 'false'}\n`);
          NODE

      - name: Skip npm publish (no packages detected)
        if: steps.detect.outputs.has_packages != 'true'
        run: echo "No publishable npm packages discovered. Skipping npm publish."

      - name: Publish packages to npm
        if: steps.detect.outputs.has_packages == 'true'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          RELEASE_VERSION: ${{ steps.version.outputs.version }}
          PRERELEASE: ${{ github.event.inputs.prerelease || 'false' }}
        run: |
          set -euo pipefail

          if [ -z "${NODE_AUTH_TOKEN:-}" ]; then
            echo "NPM_TOKEN secret is not configured."
            exit 1
          fi

          if [ -z "${RELEASE_VERSION}" ]; then
            echo "Release version is empty."
            exit 1
          fi

          publish_args=(--access public)
          if [ "${PRERELEASE}" = "true" ]; then
            publish_args+=(--tag next)
          fi

          while IFS= read -r package_dir; do
            [ -z "$package_dir" ] && continue
            if [ ! -d "$package_dir" ]; then
              echo "Skipping missing package directory $package_dir"
              continue
            fi

            package_name=$(node -pe "require('$package_dir/package.json').name")
            echo "::group::Publishing ${package_name}"
            pushd "$package_dir" > /dev/null

            npm install --ignore-scripts
            npm version "$RELEASE_VERSION" --no-git-tag-version --allow-same-version
            npm publish "${publish_args[@]}"

            popd > /dev/null
            echo "::endgroup::"
          done <<EOF
          ${{ steps.detect.outputs.paths }}
          EOF

  # ==========================================
  # PyPI Publishing (Python package)
  # ==========================================
  publish-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'release' ||
      github.event_name == 'push' ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.registries == 'all' || github.event.inputs.registries == 'pypi-only'))
    
    defaults:
      run:
        working-directory: languages/python

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine setuptools wheel
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Get Version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Update Version
        run: |
          # Update version in setup.py or pyproject.toml
          if [ -f "setup.py" ]; then
            sed -i "s/version=.*,/version='${{ steps.version.outputs.version }}',/" setup.py
          fi
          if [ -f "pyproject.toml" ]; then
            sed -i "s/version = .*/version = \"${{ steps.version.outputs.version }}\"/" pyproject.toml
          fi

      - name: Build Distribution
        run: python -m build

      - name: Check Distribution
        run: twine check dist/*

      - name: Publish to Test PyPI
        if: github.event.inputs.prerelease == 'true'
        run: |
          # shellcheck disable=SC2086
          twine upload --repository testpypi dist/* --non-interactive
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.TEST_PYPI_TOKEN }}
        continue-on-error: true

      - name: Publish to PyPI
        if: github.event.inputs.prerelease != 'true'
        run: |
          # shellcheck disable=SC2086
          twine upload dist/* --non-interactive
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}

  # ==========================================
  # Maven Publishing (Java packages)
  # ==========================================
  publish-maven:
    name: Publish to Maven Central
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'release' ||
      github.event_name == 'push' ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.registries == 'all' || github.event.inputs.registries == 'maven-only'))

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'
          server-id: ossrh
          server-username: MAVEN_USERNAME
          server-password: MAVEN_PASSWORD
          gpg-private-key: ${{ secrets.MAVEN_GPG_PRIVATE_KEY }}
          gpg-passphrase: MAVEN_GPG_PASSPHRASE

      - name: Check for Maven Projects
        id: check_maven
        run: |
          if find . -name "pom.xml" -type f | grep -q .; then
            echo "has_maven=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_maven=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Get Version
        if: steps.check_maven.outputs.has_maven == 'true'
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Update Maven Version
        if: steps.check_maven.outputs.has_maven == 'true'
        run: |
          # Update versions in all pom.xml files
          # shellcheck disable=SC2044
          for pom in $(find . -name "pom.xml"); do
            dir=$(dirname "$pom")
            (cd "$dir" && mvn versions:set -DnewVersion="${{ steps.version.outputs.version }}" -DgenerateBackupPoms=false)
          done

      - name: Build with Maven
        if: steps.check_maven.outputs.has_maven == 'true'
        run: |
          # Build each Maven project
          # shellcheck disable=SC2044
          for pom in $(find . -name "pom.xml"); do
            dir=$(dirname "$pom")
            echo "Building Maven project in $dir"
            (cd "$dir" && mvn clean package -DskipTests)
          done

      - name: Publish to Maven Central
        if: steps.check_maven.outputs.has_maven == 'true'
        run: |
          # Deploy each Maven project
          # shellcheck disable=SC2044
          for pom in $(find . -name "pom.xml"); do
            dir=$(dirname "$pom")
            echo "Deploying Maven project in $dir"
            (cd "$dir" && mvn deploy -DskipTests)
          done
        env:
          MAVEN_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.OSSRH_TOKEN }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.MAVEN_GPG_PASSPHRASE }}

      - name: Publish to GitHub Packages (Maven)
        if: steps.check_maven.outputs.has_maven == 'true'
        run: |
          # Configure for GitHub Packages
          mkdir -p ~/.m2
          printf '%s\n' '<settings><servers><server><id>github</id><username>'"${GITHUB_ACTOR}"'</username><password>'"${GITHUB_TOKEN}"'</password></server></servers></settings>' > ~/.m2/settings.xml
          # Deploy to GitHub Packages
          # shellcheck disable=SC2044
          for pom in $(find . -name "pom.xml"); do
            dir=$(dirname "$pom")
            echo "Deploying Maven project to GitHub Packages in $dir"
            (cd "$dir" && mvn deploy -DskipTests -DaltDeploymentRepository="github::default::https://maven.pkg.github.com/${{ github.repository }}")
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

  # ==========================================
  # Create GitHub Release with Assets
  # ==========================================
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [publish-npm, publish-pypi, publish-maven]
    if: always() && (github.event_name == 'workflow_dispatch' || github.event_name == 'push') && (needs.publish-npm.result == 'success' || needs.publish-pypi.result == 'success' || needs.publish-maven.result == 'success')
    
    permissions:
      contents: write
      
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Get Version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Generate Release Notes
        id: notes
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          cat > release_notes.md << EOF
          # Release v${VERSION}

          ## Packages Published

          ### NPM
          - [adaptive-tests](https://www.npmjs.com/package/adaptive-tests)
          - [jest-adaptive](https://www.npmjs.com/package/jest-adaptive)
          - [vite-plugin-adaptive](https://www.npmjs.com/package/vite-plugin-adaptive)
          - [webpack-plugin-adaptive](https://www.npmjs.com/package/webpack-plugin-adaptive)

          ### PyPI
          - [adaptive-tests-py](https://pypi.org/project/adaptive-tests-py/)

          ## Installation
          \`\`\`bash
          npm install adaptive-tests@${VERSION}
          pip install adaptive-tests-py==${VERSION}
          \`\`\`
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: v${{ steps.version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ github.event.inputs.prerelease == 'true' }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ==========================================
  # Notification
  # ==========================================
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [publish-npm, publish-pypi, publish-maven, create-release]
    if: always()
    
    steps:
      - name: Notify Success
        if: success()
        run: |
          echo "✅ Successfully published to all registries!"
          echo "NPM: ${{ needs.publish-npm.result }}"
          echo "PyPI: ${{ needs.publish-pypi.result }}"
          echo "Maven: ${{ needs.publish-maven.result }}"

      - name: Notify Failure
        if: failure()
        run: |
          echo "❌ Some publishes failed"
          echo "NPM: ${{ needs.publish-npm.result }}"
          echo "PyPI: ${{ needs.publish-pypi.result }}"
          echo "Maven: ${{ needs.publish-maven.result }}"
