# PHP Quick Start Guide

Adaptive Tests now supports PHP discovery and PHPUnit test generation! This guide will help you get started with PHP adaptive testing.

## Overview

The PHP implementation allows you to:

- Discover PHP classes, interfaces, traits, and functions
- Generate PHPUnit test scaffolds automatically
- Maintain resilient tests that survive refactoring

## Installation

The PHP support is built into the main adaptive-tests npm package:

```bash
npm install adaptive-tests
```

## Usage

### Scaffolding PHP Tests

Generate PHPUnit test files for your PHP code:

```bash
# Scaffold a single PHP file
npx adaptive-tests scaffold src/Calculator.php

# Scaffold all PHP files in a directory
npx adaptive-tests scaffold --batch src/

# Force overwrite existing test files
npx adaptive-tests scaffold src/Calculator.php --force
```

### Generated Test Structure

The scaffold command generates PHPUnit test files with:

- Proper namespace (Tests\YourNamespace)
- Correct use statements
- Test methods for all public methods
- PHPUnit annotations and best practices
- A discovery test to verify the class can be found

Example generated test:

```php
<?php

namespace Tests\YourNamespace;

use PHPUnit\Framework\TestCase;
use YourNamespace\YourClass;

/**
 * Adaptive test for YourClass
 *
 * @generated by adaptive-tests
 */
class YourClassTest extends TestCase
{
    private $target;

    protected function setUp(): void
    {
        parent::setUp();
        // Initialize your target here
    }

    public function testYourMethod()
    {
        // TODO: Implement test
        $this->markTestIncomplete(
            'This test has not been implemented yet.'
        );
    }
}
```

## Writing Adaptive Tests with PHPUnit

Once you've scaffolded a test, you can use the adaptive discovery system to make your tests resilient to refactoring. Here's a complete example:

```php
<?php

namespace Tests\Calculator;

use PHPUnit\Framework\TestCase;

/**
 * Adaptive test for Calculator - survives namespace/file moves
 *
 * @generated by adaptive-tests (enhanced)
 */
class CalculatorTest extends TestCase
{
    private $calculator;

    protected function setUp(): void
    {
        parent::setUp();

        // Discover Calculator by signature - survives refactoring
        $calculatorClass = $this->discoverTarget([
            'name' => 'Calculator',
            'type' => 'class',
            'methods' => ['add', 'subtract', 'multiply', 'divide']
        ]);

        $this->calculator = new $calculatorClass();
    }

    public function testAddition()
    {
        $result = $this->calculator->add(5, 3);
        $this->assertEquals(8, $result);
    }

    public function testSubtraction()
    {
        $result = $this->calculator->subtract(10, 4);
        $this->assertEquals(6, $result);
    }

    public function testMultiplication()
    {
        $result = $this->calculator->multiply(6, 7);
        $this->assertEquals(42, $result);
    }

    public function testDivision()
    {
        $result = $this->calculator->divide(15, 3);
        $this->assertEquals(5, $result);
    }

    public function testDivisionByZero()
    {
        $this->expectException(\InvalidArgumentException::class);
        $this->calculator->divide(10, 0);
    }

    /**
     * Discover PHP class by signature using Node.js bridge
     */
    private function discoverTarget(array $signature): string
    {
        // This would use the Node.js discovery engine via process call
        // For now, fallback to direct class reference
        // In production, this discovers the actual class location

        $output = shell_exec(sprintf(
            'node -e "const { discover } = require(\'adaptive-tests\'); discover(%s).then(c => console.log(c.name || \'%s\'));"',
            json_encode($signature),
            'App\\Calculator\\Calculator'  // fallback
        ));

        return trim($output) ?: 'App\\Calculator\\Calculator';
    }
}
```

## Discovery Signatures for PHP

PHP discovery signatures support comprehensive metadata:

```php
// Discover by class name and methods
$signature = [
    'name' => 'UserService',
    'type' => 'class',
    'methods' => ['createUser', 'findUser', 'deleteUser'],
    'namespace' => 'App\\Services'
];

// Discover by interface implementation
$signature = [
    'name' => 'PaymentProcessor',
    'type' => 'class',
    'implements' => ['PaymentInterface'],
    'methods' => ['processPayment', 'refund']
];

// Discover by trait usage
$signature = [
    'name' => 'Loggable',
    'type' => 'trait',
    'methods' => ['log', 'error', 'info']
];

// Discover functions
$signature = [
    'name' => 'calculateTax',
    'type' => 'function',
    'parameters' => ['amount', 'rate']
];
```

## Directory Structure

Adaptive tests work best with organized directory structures:

```text
src/
├── Calculator/
│   ├── Calculator.php
│   └── MathUtils.php
└── Services/
    ├── UserService.php
    └── PaymentService.php

tests/
├── Calculator/
│   ├── CalculatorTest.php
│   └── MathUtilsTest.php
└── Services/
    ├── UserServiceTest.php
    └── PaymentServiceTest.php
```

## PHP Discovery Features

The PHP discovery engine supports:

### Classes

- Public, protected, and private methods
- Properties with visibility modifiers
- Abstract and final classes
- Class inheritance (extends)
- Interface implementation

### Interfaces

- Method signatures
- Interface inheritance

### Traits

- Trait methods
- Use in classes

### Functions

- Global functions
- Function parameters and return types

## File Organization

By default, PHP test files are placed in the `tests/` directory with the naming convention `{ClassName}Test.php`.

You can specify a custom output directory:

```bash
npx adaptive-tests scaffold src/Calculator.php --output-dir=tests/Unit
```

## Examples

The repository includes PHP examples in `examples/php/`:

- `Calculator.php` - Simple calculator class
- `UserService.php` - Complex service with interface and trait

To try them:

```bash
# Generate tests for the examples
npx adaptive-tests scaffold --batch examples/php/src

# View the generated tests
ls tests/
```

## Integration with PHPUnit

The generated tests are standard PHPUnit test classes. Run them with:

```bash
# Using PHPUnit directly
vendor/bin/phpunit tests/

# Using composer scripts
composer test
```

## PHP Version Support

The discovery engine uses the `php-parser` npm package which supports:

- PHP 5.x
- PHP 7.x
- PHP 8.x (including PHP 8.2+ features)

## Best Practices

1. **Namespace Organization**: Use PSR-4 autoloading standards
2. **Test Location**: Keep tests in a `tests/` directory mirroring your source structure
3. **Discovery Hints**: Use clear, descriptive class and method names
4. **Documentation**: Add PHPDoc comments to improve discovery accuracy

## Limitations

- PHP discovery runs in Node.js, not PHP runtime
- Tests are scaffolded but not executed by adaptive-tests
- Complex PHP features (anonymous classes, dynamic properties) may have limited support
- Discovery focuses on static analysis, not runtime behavior

## Next Steps

- Explore the [examples/php](../examples/php) directory
- Read about [discovery signatures](./HOW_IT_WORKS.md) for advanced usage
- Learn about [CI/CD integration](./CI_STRATEGY.md) for PHP projects
